<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat Window</title>
<style>
body {
  font-family: Meiryo, sans-serif;
  margin: 0;
  padding: 10px;
}

#messages {
  border: 1px solid #aaa;
  height: 400px;
  overflow-y: auto;
  padding: 6px;
}

.message {
  display: flex;
  margin-bottom: 4px;
}

.sender {
  width: 100px;
  font-weight: bold;
  border: 1px solid #ccc;
  margin-right: 6px;
  padding: 2px 4px;
}

.text {
  flex: 1;
  border: 1px solid #ddd;
  padding: 4px;
  white-space: pre-wrap;
}

#input {
  margin-top: 10px;
  display: flex;
  gap: 6px;
}
</style>
</head>

<body>

<div id="messages"></div>

<div id="input">
  <input id="sender" placeholder="話者" style="width:120px">
  <textarea id="text" rows="3" style="flex:1"></textarea>
  <button onclick="sendMessage()">送信</button>
</div>

<script>
let lastId = 0;

async function fetchMessages() {
  const res = await fetch("/messages");
  const data = await res.json();

  for (const msg of data) {
    if (msg.id > lastId) {
      addMessage(msg.sender, msg.text);
      lastId = msg.id;
    }
  }
}

function addMessage(sender, text) {
  const div = document.createElement("div");
  div.className = "message";

  div.innerHTML = `
    <div class="sender">${sender}</div>
    <div class="text"></div>
  `;
  div.querySelector(".text").textContent = text;

  const messages = document.getElementById("messages");
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
}

async function sendMessage() {
  const sender = document.getElementById("sender").value.trim();
  const text = document.getElementById("text").value.trim();
  if (!text) return;

  await fetch("/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sender, text })
  });

  document.getElementById("text").value = "";
}

setInterval(fetchMessages, 500);
</script>

</body>
</html>
